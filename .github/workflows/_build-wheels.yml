name: Build Wheels

# Reusable workflow for cross-platform Python wheel builds
on:
  workflow_call:
    inputs:
      ref:
        type: string
        required: false
        default: ''
        description: 'Git ref to checkout (empty = default)'
      maturin-extra-args:
        type: string
        required: false
        default: ''
        description: 'Extra args for maturin (e.g., --find-interpreter)'

jobs:
  build-wheels:
    name: Build wheels (${{ matrix.platform-name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64
            platform-name: linux-x86_64
          - os: ubuntu-latest
            target: aarch64
            platform-name: linux-aarch64
          - os: macos-latest
            target: aarch64
            platform-name: macos-aarch64
          - os: windows-latest
            target: x86_64
            platform-name: windows-x86_64

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          working-directory: sunscreen_fhe
          target: ${{ matrix.target }}
          args: --release --out dist ${{ inputs.maturin-extra-args }}
          manylinux: auto

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform-name }}
          path: sunscreen_fhe/dist
          retention-days: 7
